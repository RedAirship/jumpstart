# Demo: Using password-jwt to validate JWT tokens

In the previous section, we learned how to use `express-jwt` to validate JWT tokens. We could do the same with another library called [passport-jwt](https://www.npmjs.com/package/passport-jwt). It's a strategy for passport.js to handle authentication with JWT tokens.

We have a [sample project](https://github.com/thoughtworks-jumpstart/express-auth-demo) which shows how to save JWT in cookies after authentication and how to use password-jwt to validate JWT tokens in subsequent requests.

Here are the highlights of the sample codes

## Returning JWT in cookies

```javascript
// routes/indexRouter.js
const { jwtOptions } = require("../config/passport");

router.post("/signin", async (req, res) => {
  const { username, password } = req.body;
  const user = await User.findOne({ username });

  if (!user) res.status(401).json({ message: "no such user found" });

  if (user.validatePassword(password)) {
    const userId = { id: user.id };
    const token = jwt.sign(userId, jwtOptions.secretOrKey);

    // send token via res.cookie()
    res.cookie("jwt", token, {
      sameSite: true,
      httpOnly: true,
      secure: true
    });
    res.json({ message: "ok" });
  } else {
    res.status(401).json({ message: "passwords did not match" });
  }
});
```

Note that the JWT token contains a field "id", which stores the ID of each user (as generated by MongoDB). 

## passport.js configuration to retrieve JWT from cookies

We an configure passport.js with a `JWT` strategy which knows how to validate JWT tokens in HTTP requests and only grant access to protected resources if valid JWT tokens present.

```javascript
// middlewares/passport.js
const passport = require("passport");
const passportJWT = require("passport-jwt");
const JwtStrategy = passportJWT.Strategy;

const User = require("../models/user");

const cookieExtractor = function(req) {
  var token = null;
  console.log(req.cookies);
  if (req && req.cookies) {
    token = req.cookies["jwt"];
  }
  return token;
};

const jwtOptions = {
  jwtFromRequest: cookieExtractor,
  secretOrKey: process.env.JWT_SECRET
};

const verify = async (jwt_payload, done) => {
  const user = await User.findOne({ _id: jwt_payload.id });
  if (user) {
    done(null, user);
  } else {
    done(null, false);
  }
};

const jwtStrategy = new JwtStrategy(jwtOptions, verify);

passport.use(jwtStrategy);

module.exports = {
  passport
};
```

Note:

- The `verify` function would be called by the `passport-jwt` library, which will supply the `jwt_payload` parameter once the JWT token is extracted using the `cookieExtractor` function. 
- From the `jwt_payload`, we can get the `id` of the user and search database with that ID.
- If the user is found and passed to the `done()` callback, the `passport-jwt` library would save the user in the `request.user` field for other request handlers to use.

## Initialize passport.js in app.js

```javascript
// in app.js
const { passport } = require("./middlewares/passport");
app.use(passport.initialize());
```

## Use passport.js as middleware for authentication

With the passport.js configuration with `JWT` strategy, we can protect our routes in the following way:

```javascript
// in app.js
app.use(
  "/secret",
  passport.authenticate("jwt", { session: false }),
  secretsRouter
);
```

## Use req.user in a route handler protected by passport.js

Once the authentication is done successfully, the passport.js middleware saves the user information in the `req.user` field.

In this example, since the `secretsRouter` is after the `passport.js` middleware in the pipeline, we can use the `req.user`, e.g.

```javascript
router.get("/", (req, res, next) => {
  const username = req.user.username;
  res.json({ message: `Success! ${username}, you are on a protected page` });
});
```

Note: **pay attention to this difference!** When we were using the `express-jwt` library for authentication, `express-jwt` saves the JWT token payload in the `req.user` field, but this `passport-jwt` saves the user model (retrieved from database) in the `req.user` field.

## Another Example

Here is [another tutorial](https://medium.com/front-end-hacking/learn-using-jwt-with-passport-authentication-9761539c4314) which shows the usage of both local strategy and JWT strategy:

- local strategy is used to authenticate user with user name and password
- JWT strategy is used to validate JWT tokens in the subsequent requests

## Lab

- Update the previous project we used for JWT demo and use passport JWT strategy for validating JWT tokens (instead of using express-jwt library)

## Resources

- [Session-less authentication with jwt and passport](https://blog.usejournal.com/sessionless-authentication-withe-jwts-with-node-express-passport-js-69b059e4b22c)
